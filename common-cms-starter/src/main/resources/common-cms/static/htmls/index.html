<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>common-cms</title>
    <link rel="stylesheet" href="${contextPath}/static/element-ui/theme-chalk/index.css">
    <link href="${contextPath}/static/lightbox-dialog/dist/css/Lobibox.min.css" rel="stylesheet">
    <link href="${contextPath}/static/cropper/cropper.css" rel="stylesheet">
    <script src="${contextPath}/static/vue.min.js"></script>
    <script src="${contextPath}/static/element-ui/index.js"></script>
    <script src="${contextPath}/static/axios.min.js"></script>
    <script src="${contextPath}/static/jquery.min.js" type="text/javascript"></script>
    <script src="${contextPath}/static/lightbox-dialog/dist/js/lobibox.min.js"></script>
    <script src="${contextPath}/static/qiniu.min.js"></script>
    <script src="${contextPath}/static/UEditor/vue-ueditor-wrap.min.js"></script>
    <script src="${contextPath}/static/cropper/cropper.js"></script>
    <style>
        .competitors .is-leaf {
            padding-top: 3px;
            padding-bottom: 3px;
        }
        .competitors .el-table__row td {
            padding-top: 3px;
            padding-bottom: 3px;
        }
        .el-card__body {
            padding: 5px;
            font-size: 14px;
        }
        .clearfix:before,
        .clearfix:after {
            display: table;
            content: "";
        }
        .clearfix:after {
            clear: both
        }
        .el-card__header {
            padding-top: 0px;
            padding-bottom: 0px;
        }
        #position {
            height: 270px;
            overflow: hidden;
        }
        body .el-table th.gutter{
            display: table-cell!important;
        }
        .line-limit-length {
            /*overflow: hidden;*/
            /*text-overflow: ellipsis;*/
            /*white-space: nowrap; //文本不换行，这样超出一行的部分被截取，显示...*/
        }
        .c-card {
            border-top-color: #dd4b39;
            border-top-width: 3px;
            margin-top: 10px;
        }
        .el_btn {
            color: #fff;
            background-color: #409EFF;
            border: 1px #409EFF solid;
            border-radius: 4px;
            padding-top: 9px;
            padding-bottom: 9px;
            padding-left: 15px;
            padding-right: 15px;
            font-size: 12px;
            font-family: Arial;
            font-weight: 500;
        }
        .follow-dialog .el-dialog__body {
            padding: 2px;
        }
        .jcrop_dialog .el-dialog__body {
            padding-left: 0px;
            padding-right: 0px;
        }
    </style>
</head>
<body style="background-color: rgba(237,240,245);">
<div id="app" v-loading="loading">
    <el-row :gutter="24" style="margin-left: -5px; margin-right: -5px;">
        <el-col :span="24" id="search-card"></el-col>
        <el-col :span="24" id="btn-card">
        </el-col>
        <el-col :span="24" id="table-card"></el-col>
    </el-row>

    <el-dialog :title="tt" :width="addFormWidth" :close-on-click-modal="false" :visible.sync="addVisible" class="group-dialog" :before-close="cancelAdd" v-loading="loading">
        <el-form :model="addForm" :rules="addRules" ref="addForm" size="small" id="add-form" v-loading="loading">
        </el-form>
    </el-dialog>

    <el-dialog :visible.sync="imgShowVisible" :before-close="closeImgShow">
        <img width="100%" :src="imgShowUrl" alt="">
    </el-dialog>

    <el-dialog class="follow-dialog" :close-on-click-modal="false" :title="followDialogName" width="90%" :visible.sync="followDialogVisible" :before-close="closeFollowDialog">
        <iframe id="Ateon-SetParent-iframe" :src="followTableUrl" style="border: 0px" width="100%"></iframe>
    </el-dialog>

    <el-dialog class="jcrop_dialog" :close-on-press-escape="false" title="图片裁剪" width="70%" :visible.sync="jcrop.visible" class="group-dialog" :before-close="closeJcrop">
        <div v-loading="loading">
            <div>
                <img id="jcrop_img" width="80%"/>
            </div>
            <el-row :gutter="24" style="margin-top: 8px;">
                <el-col :span="6">
                    <el-input size="mini" readonly="true" v-model="jcrop.width">
                        <template slot="prepend">宽</template>
                        <template slot="append">px</template>
                    </el-input>
                </el-col>
                <el-col :span="6">
                    <el-input size="mini" readonly="true" v-model="jcrop.height">
                        <template slot="prepend">高</template>
                        <template slot="append">px</template>
                    </el-input>
                </el-col>
                <el-col :span="12" style="text-align: right;">
                    <el-button @click="cancelJcrop" size="small">取 消</el-button>
                    <el-button type="primary" @click="confirmJcrop" size="small">确 定</el-button>
                </el-col>
            </el-row>
        </div>
    </el-dialog>
</div>

<script>
    window.contextPath = '${contextPath}'
</script>
<script src="${contextPath}/static/form-create/main.js?v=999"></script>
<script src="${contextPath}/static/form-create/method.js?v=888"></script>
<script>
    $.ajax({
        type: 'get',
        url: window.contextPath + '/config/api/query',
        async: false,
        contentType: 'application/json',
        data: {},
        dataType:'json',
        success:function (data) {
            if (data.status != 0) {
                alert(data.msg)
            } else {
                window.config = {}
                document.title = data.content.title
                searchForm(data.content)
                table(data.content)
                followTable(data.content)
                addForm(data.content)
                btn(data.content)
            }
        },
        error: function(errorThrown) {
            console.error(errorThrown)
            alert('配置加载异常')
        }
    })
</script>
<script>
    var mainTable = new Vue({
        name: 'app',
        el: '#app',
        data() {
            var validate = (rule, value, callback) => {
                if (!value) {
                    if (rule.required) {
                        return callback(new Error(rule.message))
                    }
                    return callback()
                }
                setTimeout(() => {
                    var reg = new RegExp(rule.regularStr);
                    if (!reg.test(value)) {
                        callback(new Error(rule.message))
                    } else {
                        callback()
                    }
                }, 100)
            }
            return {
                showSearchTitle: true,
                loading: false,
                searchForm: window.config.searchForm,
                list: [],
                sortColumn: window.config.sortColumn,
                order: window.config.order,
                totalCount: 0,
                pageSize: window.config.pageSize,
                curPage: window.config.curPage,
                tt: '',
                edit: null,
                addVisible: false,
                addForm: {},
                addRules: window.config.addRules,
                addFormWidth: window.addFormWidth,
                formLabelWidth: '100px',
                selections: [],
                imgShowVisible: false,
                imgShowUrl: '',
                followDialogName: null,
                followDialogVisible: false,
                followTableUrl: null,
                richConfig: window.richConfig,
                jcrop: {
                    visible: false
                }
            }
        },
        mounted: function() {
        },
        methods: {
            confirmJcrop() {
                this.loading = true
                $("#jcrop_img").cropper('getCroppedCanvas').toBlob((blob) => {
                    let file = new File([blob], this.jcrop.filename, {type: this.jcrop.imageType, lastModified: Date.now()});
                    let observable = qiniu.upload(file, this.jcrop.key, this.jcrop.token, {}, {
                        useCdnDomain: true
                    });
                    observable.subscribe({
                        next: (result) => {
                            console.info(result);
                        },
                        error: () => {
                            this.$message.error('上传图片失败');
                            this.loading = false;
                        },
                        complete: (res) => {
                            this.addForm[this.jcrop.k] = this.jcrop.host + '/' + res.key;
                            this.addForm = JSON.parse(JSON.stringify(this.addForm))
                            this.loading = false;
                            this.closeJcrop()
                        }
                    })
                })
            },
            cancelJcrop() {
                this.closeJcrop()
            },
            closeJcrop() {
                this.jcrop = {
                    visible: false
                }
            },
            jump(paramFormDb, p, url) {
                jump({
                    paramFormDb: paramFormDb,
                    p: p,
                    url: url,
                    vue: this
                })
            },
            closeFollowDialog() {
                this.followDialogName = null
                this.followDialogVisible = false
                this.followTableUrl = null
                this.$refs.mainTable.clearSelection();
            },
            showFollow(bottomName, key) {
                let row = null;
                if (this.selections && this.selections.length == 1) {
                    row = this.selections[0]
                }
                if (!row) {
                    console.error("no selection")
                    return
                }
                this.followDialogName = bottomName
                this.followTableUrl = encodeURI('follow/html?bottomName=' + bottomName + '&value=' + row[key])
                this.followDialogVisible = true
            },
            uploadImg(id, k, cut) {
                this.loading = true;
                let ele = $('#' + id)
                if ($(ele).val() != '') {
                    let file = $(ele)[0].files[0];
                    if (file.type.indexOf('image/') == -1) {
                        this.$message.warning('请上传图片');
                        $(ele).val('')
                        this.loading = false;
                        return
                    }
                    if ($(ele)[0].hasAttribute('limit-size')) {
                        let limitSize = $($(ele)[0]).attr('limit-size')
                        if (limitSize < file.size) {
                            this.$message.warning('图片大小不能超过' + (limitSize / 1024 / 1024) + 'M');
                            $(ele).val('')
                            this.loading = false;
                            return
                        }
                    }
                    let name = $(ele).val();
                    axios.get(window.contextPath + '/upload/api/token',{
                        params: {
                            file_name: name,
                            type: 'img'
                        }
                    }).then(res => {
                        if (res.data.status != 0) {
                            this.$message.error(res.data.msg);
                        }
                        else {
                            let host = res.data.content.host;
                            let token = res.data.content.token;
                            let key = res.data.content.key;
                            if (cut === true || cut === 'true') {
                                this.loading = false;
                                this.$confirm('裁剪图片?', '提示', {
                                    confirmButtonText: '裁剪',
                                    cancelButtonText: '使用原图',
                                    type: 'warning'
                                }).then(() => {
                                    this.loading = true;
                                    this.jcrop = {
                                        visible: true,
                                        filename: name,
                                        host: host,
                                        token: token,
                                        key: key,
                                        k: k,
                                        imageType: file.type
                                    }
                                    this.$nextTick(() => {
                                        $("#jcrop_img").cropper('destroy').attr('src', URL.createObjectURL(file))
                                            .cropper({
                                                viewMode: 2,        //全屏铺满，再缩小都没有空隙
                                                dragMode: 'move',   //制动拖动方式
                                                crop: (data) => {
                                                    console.log(Math.round(data.x))
                                                    console.log(Math.round(data.y))
                                                    console.log(Math.round(data.height))
                                                    console.log(Math.round(data.width))
                                                    console.log(Math.round(data.rotate))
                                                    console.log(this.jcrop)
                                                    this.jcrop.width = Math.round(data.width)
                                                    this.jcrop.height = Math.round(data.height)
                                                    this.jcrop = JSON.parse(JSON.stringify(this.jcrop))
                                                }
                                            });
                                        this.loading = false
                                    })
                                }).catch(() => {
                                    let observable = qiniu.upload(file, key, token, {}, {
                                        useCdnDomain: true
                                    });
                                    observable.subscribe({
                                        next: (result) => {
                                            console.info(result);
                                        },
                                        error: () => {
                                            this.$message.error('上传图片失败');
                                            this.loading = false;
                                        },
                                        complete: (res) => {
                                            this.addForm[k] = host + '/' + res.key;
                                            this.addForm = JSON.parse(JSON.stringify(this.addForm))
                                            this.loading = false;
                                        }
                                    })
                                });
                            } else {
                                let observable = qiniu.upload(file, key, token, {}, {
                                    useCdnDomain: true
                                });
                                observable.subscribe({
                                    next: (result) => {
                                        console.info(result);
                                    },
                                    error: () => {
                                        this.$message.error('上传图片失败');
                                        this.loading = false;
                                    },
                                    complete: (res) => {
                                        this.addForm[k] = host + '/' + res.key;
                                        this.addForm = JSON.parse(JSON.stringify(this.addForm))
                                        this.loading = false;
                                    }
                                })
                            }
                        }
                    }).catch(res => {
                        console.error(res)
                        this.$message.error('获取token失败');
                        this.loading = false;
                    })

                    // var formData = new FormData();
                    // var name = $(ele).val();
                    // formData.append("file", file);
                    // formData.append("name", name);
                    // $.ajax({
                    //     url: window.contextPath + '/upload/file',
                    //     type: 'POST',
                    //     data: formData,
                    //     processData: false,// ⑧告诉jQuery不要去处理发送的数据
                    //     contentType: false, // ⑨告诉jQuery不要去设置Content-Type请求头
                    //     beforeSend: () => {
                    //         //⑩发送之前的动作
                    //     },
                    //     success: (data) => {
                    //         if (data.status != 0) {
                    //             this.$message.error(data.msg);
                    //         } else {
                    //             this.addForm[key] = data.content.data;
                    //         }
                    //         this.loading = false;
                    //     },
                    //     error : (responseStr) => {
                    //         console.error(responseStr)
                    //         this.$message.error('导入失败');
                    //         this.loading = false;
                    //     }
                    // });
                }
            },
            removeImg(id, key) {
                // delete this.addForm[key]
                this.addForm[key] = null
                this.addForm = JSON.parse(JSON.stringify(this.addForm))
                // let ele = $('#' + id)
                // $(ele).val('')
            },
            closeImgShow() {
                this.imgShowUrl = ''
                this.imgShowVisible = false
            },
            showImg(key) {
                this.imgShowUrl = this.addForm[key]
                this.imgShowVisible = true
            },
            showImgInList(url) {
                this.imgShowUrl = url
                this.imgShowVisible = true
            },
            handleSelectionChange(val) {
                this.selections = val
            },
            tableSwitch(val,row,column) {
                let form = {
                    selectJson: window.config.listJson,
                    column: column,
                    columnVal: val,
                    primaryKeyValue: row[window.config.addForm.primaryKey],
                    specialColumnParams: window.config.otherColumnTypeColumns
                }
                axios.post(window.contextPath + '/web/api/updateSwitch', form, {
                    headers: {}
                }).then(res => {
                    if (res.data.status != 0) {
                        this.$message.error(res.data.msg);
                        this.loading = false;
                    }
                    else {
                        this.loading = false;
                        this.getList()
                    }
                }).catch(res => {
                    console.error(res)
                    this.loading = false;
                })
            },
            add(formName) {
                this.loading = true;
                for (let key in this.addForm) {
                    if (this.addForm[key] === '') {
                        this.addForm[key] = null
                    }
                }
                this.$refs[formName].validate((valid) => {
                    if (valid) {
                        let form = {
                            addJson: JSON.stringify(window.config.addForm),
                            params: this.addForm,
                            specialColumnParams: window.config.otherColumnTypeColumns
                        }
                        let url = window.contextPath + '/web/api/update';
                        if (this.edit === false) {
                            url = window.contextPath + '/web/api/add';
                        }
                        axios.post(url, form, {
                            headers: {}
                        }).then(res => {
                            if (res.data.status != 0) {
                                this.$message.error(res.data.msg);
                                this.loading = false;
                            }
                            else {
                                this.cancelAdd()
                                this.loading = false;
                                this.getList()
                            }
                        }).catch(res => {
                            console.error(res)
                            this.loading = false;
                        })
                    } else {
                        this.loading = false;
                        return false;
                    }
                });
            },
            showAdd() {
                this.edit = false
                this.tt = '新增'
                this.addForm = {}
                this.addVisible = true
            },
            cancelAdd() {
                this.addForm = {}
                this.$refs.addForm.resetFields()
                this.addVisible = false
                this.$refs.mainTable.clearSelection();
                $('.img_upl').val('')
            },
            showEdit() {
                let row = null;
                if (this.selections && this.selections.length == 1) {
                    row = this.selections[0]
                }
                if (!row) {
                    console.error("no selection")
                    return
                }
                this.loading = true;
                let form = {
                    primaryKeyValue: row[window.config.addForm.primaryKey],
                    addJson: JSON.stringify(window.config.addForm),
                    columns: window.config.addColumns
                }
                axios.post(window.contextPath + '/web/api/info', form, {
                    headers: {}
                }).then(res => {
                    if (res.data.status != 0) {
                        this.$message.error(res.data.msg);
                        this.loading = false;
                    }
                    else {
                        this.addForm = res.data.content.info
                        this.tt = '编辑';
                        this.edit = true;
                        this.loading = false;
                        this.addVisible = true
                    }
                }).catch(res => {
                    console.error(res)
                    this.loading = false;
                })
            },
            del() {
                if (this.selections && this.selections.length > 0) {
                    this.$confirm('确定要删除?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        this.loading = true;
                        let primaryKeyValues = []
                        this.selections.forEach(row => {
                            primaryKeyValues.push(row[window.config.addForm.primaryKey])
                        })
                        let follow_tables = []
                        if (window.followTables) {
                            for (let key in window.followTables) {
                                if (window.followTables[key] &&
                                    (window.followTables[key].cascading_delete === true
                                    || window.followTables[key].cascading_delete === 'true')) {
                                    follow_tables.push({
                                        relateKey: window.followTables[key].relateKey,
                                        parentKey: window.followTables[key].parentKey,
                                        schema: window.followTables[key].select.schema,
                                        table: window.followTables[key].select.table,
                                        primaryKey: window.followTables[key].select.primaryKey
                                    })
                                }
                            }
                        }
                        let form = {
                            addJson: JSON.stringify(window.config.addForm),
                            primaryKeyValues: primaryKeyValues,
                            cascadingDeletes: follow_tables
                        }
                        axios.post(window.contextPath + '/web/api/delete', form, {
                            headers: {}
                        }).then(res => {
                            if (res.data.status != 0) {
                                this.$message.error(res.data.msg);
                                this.loading = false;
                            }
                            else {
                                this.loading = false;
                                this.$refs.mainTable.clearSelection();
                                this.getList();
                            }
                        }).catch(res => {
                            console.error(res)
                            this.loading = false;
                        })
                    }).catch(() => {
                    });
                }
            },
            search() {
                this.curPage = 1;
                this.getList()
            },
            sortChange(column) {
                this.sortColumn = column.prop
                this.order = column.order
                this.getList()
            },
            sizeChange(size) {
                this.pageSize = size;
                this.curPage = 1;
                this.getList()
            },
            currentChange(currentPage) {
                this.curPage = currentPage;
                this.getList()
            },
            getList() {
                this.loading = true;
                let params = []
                for (var key in this.searchForm) {
                    params.push({
                        key: key,
                        value: this.searchForm[key],
                        type: window.config.searchOthers[key].type,
                        alias: window.config.searchOthers[key].alias
                    })
                }
                let order = null;
                if (this.order == 'descending') {
                    order = 'desc'
                }
                else if (this.order == 'ascending') {
                    order = 'asc'
                } else if (this.order == 'desc') {
                    order = 'desc'
                }
                else if (this.order == 'asc') {
                    order = 'asc'
                }
                let listForm = {
                    curPage: this.curPage,
                    pageSize: this.pageSize,
                    listJson: window.config.listJson,
                    sortColumn: this.sortColumn,
                    order: order,
                    params: params
                }
                axios.post(window.contextPath + '/web/api/table/list', listForm, {
                    headers: {}
                }).then(res => {
                    if (res.data.status != 0) {
                        this.$message.error(res.data.msg);
                    }
                    else {
                        this.list = res.data.content.list;
                        this.totalCount = res.data.content.totalCount;
                    }
                    this.loading = false;
                }).catch(res => {
                    console.error(res)
                    this.loading = false;
                })
            }
        },
        created: function () {
            this.getList()
        }
    })
</script>
</body>
</html>